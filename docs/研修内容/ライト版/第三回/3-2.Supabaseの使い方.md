---
title: "AI駆動開発でマスターするSupabase実践"
track: "ライト版・第3回"
author: "TEKION Group / 泉水亮介"
last_updated: "2025年6月26日"
category: "データベース"
---

# AI駆動開発でマスターするSupabase実践

## 概要
このユニットへようこそ！ここでは、Vibe Coder Bootcampの核となる「AIに任せる開発スタイル」を実践しながら、Supabaseデータベースのセットアップからアプリケーションでの利用までをマスターします。

データベースは、アプリケーションの「心臓部」です。ユーザーの情報、投稿、商品データなど、あらゆる大切な情報を保管し、必要に応じて取り出す役割を担います。この心臓部をいかに安全かつ効率的に操作するかが、質の高いアプリケーション開発の鍵となります。

この章では、手作業での設定を極力減らし、AIアシスタントであるCursorに指示を出すことで、いかに高速かつ正確に開発を進められるかを体感していただきます。

## 学習目標
- Cursorへの適切な指示（プロンプト）によって、Supabaseの初期設定を完了できる。
- AIにNext.jsとSupabaseを連携させるためのコードを生成させることができる。
- Server ComponentsやServer Actionsを使い、AIにデータベースの読み書き（CRUD）操作を実装させることができる。
- AI駆動開発の基本的なワークフローを理解し、自走できる状態になる。

## 準備
- [3-1.データベース基礎](./3-1.データベース基礎.md)を読み終えていること。
- Supabaseのアカウントを作成し、新しいプロジェクトを1つ作っておくこと。
    - プロジェクト作成時に表示される「Project URL」と「Project API Keys」の`anon (public)`キーを控えておく。

---

## 1. Supabase連携の土台作り (ハンズオン)

ここからは、すべての作業をCursorと対話しながら進めます。アプリケーションとSupabaseが「会話」するための準備を整えましょう。

### ステップ1: 必要なライブラリのインストール

まず、Next.jsプロジェクトからSupabaseを操作するための公式ライブラリをインストールします。

**▶ Cursorへの指示 (プロンプト例)**
> Next.jsプロジェクトでSupabaseを使いたいので、必要な公式ライブラリをインストールしてください。

Cursorは`@supabase/supabase-js`をインストールするコマンドを提案してくれるはずです。ターミナルで実行しましょう。

```bash
npm install @supabase/supabase-js
```

> **💡 Tips: `@supabase/supabase-js`とは？**
> このライブラリは、私たちのアプリケーションとSupabaseデータベースが、安全かつ簡単に「会話」をするための**「公式通訳者」**のようなものです。
>
> 本来、データベースと通信するには、HTTPリクエストという複雑な形式のメッセージを送受信する必要があります。しかし、このライブラリを使えば、`select`（取得）や`insert`（追加）といった直感的な命令文を書くだけで、ライブラリが裏側で面倒な通信処理をすべて代行してくれます。これにより、私たちはより本質的なアプリケーションの機能開発に集中できるのです。

### ステップ2: 環境変数の設定

次に、SupabaseプロジェクトのURLとAPIキーを安全に管理するための「環境変数」を設定します。

**▶ Cursorへの指示 (プロンプト例)**
> Supabaseに接続するための環境変数を設定したいです。プロジェクトのルートに`.env.local`ファイルを作成し、以下のキーを追記してください。
> - `NEXT_PUBLIC_SUPABASE_URL`
> - `NEXT_PUBLIC_SUPABASE_ANON_KEY`
>
> それぞれの値はあとで自分で入力します。

Cursorが`.env.local`ファイルを作成し、中身を記述してくれます。ファイルを開き、Supabaseのダッシュボードで控えておいた自分のURLとanonキーを貼り付けます。

```.env.local
NEXT_PUBLIC_SUPABASE_URL="YOUR_SUPABASE_URL"
NEXT_PUBLIC_SUPABASE_ANON_KEY="YOUR_SUPABASE_ANON_KEY"
```

> **【深掘りコラム】なぜAPIキーをコードに直接書いてはいけないのか？**
>
> APIキーやデータベースURLは、家の「鍵」や「住所」のような非常に重要な情報です。もし、これらの情報をソースコードに直接書き込んでGitHubなどの公開リポジトリにアップロードしてしまうと、世界中の誰もがあなたのデータベースにアクセスできてしまいます。
>
> **具体的なリスク:**
> - **データの漏洩・改ざん:** 悪意のある第三者にデータベースを操作され、個人情報が盗まれたり、データが破壊されたりする可能性があります。
> - **不正利用:** データベースの利用料が不正に跳ね上がり、高額な請求が来る可能性があります。
> - **管理の煩雑化:** キーを変更するたびに、コード内のすべての記述箇所を探して修正する必要があり、非常に手間がかかります。
>
> **環境変数**は、これらの秘密情報を安全に保管するための**「鍵付きの金庫」**です。`.env.local`ファイルは、`.gitignore`という設定によってGitの管理対象から意図的に外されています。そのため、GitHubにアップロードされることがなく、ローカル環境だけで安全に秘密情報を管理できるのです。

### ステップ3: Supabaseクライアントの作成

アプリケーションのどこからでもSupabaseを呼び出せるように、設定をまとめた「クライアント」ファイルを作成します。

**▶ Cursorへの指示 (プロンプト例)**
> `lib`ディレクトリに`supabase`というフォルダを作り、その中に`client.ts`というファイルを作成してください。
> このファイルでは、`.env.local`に設定した環境変数を読み込んで、Supabaseのクライアントを初期化し、エクスポートしてください。

Cursorは以下のようなコードを生成するでしょう。

```typescript:lib/supabase/client.ts
// Supabaseと連携するためのクライアント作成機能（createClient）をライブラリからインポートします。
import { createClient } from '@supabase/supabase-js'

// .env.localからSupabaseのURLを読み込みます。
// `!`は「この変数は絶対に存在するので、nullやundefinedではない」とTypeScriptに伝える記号です。
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!
// .env.localからSupabaseのanonキー（公開鍵）を読み込みます。
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!

// 読み込んだURLとキーを使って、Supabaseクライアントのインスタンス（実体）を作成します。
// これがデータベース操作の窓口となります。
export const supabase = createClient(supabaseUrl, supabaseAnonKey)
```

> **💡 Tips: なぜクライアントを作るの？**
> このクライアントファイルは、いわば**「Supabaseへの専用窓口」**です。
>
> もしこのファイルがなければ、データベースを操作したいファイル（ページ）のすべてで、毎回環境変数を読み込んでクライアントを作成するコードを書く必要があります。これは非効率ですし、もし接続情報に変更があった場合、すべてのファイルの修正が必要になり、修正漏れのリスクも高まります。
>
> このように専用窓口を一つ作っておけば、アプリ内のどこからでもこの`supabase`オブジェクトをインポートするだけで、一貫した設定で安全にデータベースとやり取りできるようになります。これを**「関心の分離」**と呼び、メンテナンス性の高いコードを書くための重要な設計原則の一つです。

---

## 2. AIと共に実装するCRUD操作 (ハンズオン)

クライアントの準備ができたので、いよいよデータの操作を実装します。CRUD（Create, Read, Update, Delete）は、あらゆるアプリケーションの基本となる4つの操作です。ここでも主役はCursorです。

### ステップ4: データの取得 (Read) - Server Componentsの力を借りて

まず、Supabaseに保存されているデータを取得して画面に表示します。例として、`posts`テーブルから全ての投稿を取得するページを作ります。

**▶ Cursorへの指示 (プロンプト例)**
> `app/posts/page.tsx`というファイルを作成してください。
> このページはServer Componentとして、先ほど作成したSupabaseクライアントを使って`posts`テーブルから全てのデータを取得し、`created_at`の降順で並び替えてください。
> 取得したデータは、単純な`div`要素で内容(`content`)を一覧表示してください。

Cursorは、データの取得からUIへのマッピングまで、一気通貫でコードを生成します。

```typescript:app/posts/page.tsx
// lib/supabase/client.tsで作成した、Supabaseとの通信窓口をインポートします。
import { supabase } from '@/lib/supabase/client'

// このページは非同期（async）のServer Componentとして定義します。
// これにより、サーバー側でデータ取得が完了してからHTMLが生成されます。
export default async function PostsPage() {
  // supabaseクライアントを使い、データベースに問い合わせを行います。
  const { data: posts, error } = await supabase
    .from('posts') // 'posts'という名前のテーブルを指定します。
    .select('*')   // '*'は「すべての列（カラム）」を取得するという意味です。
    .order('created_at', { ascending: false }) // 'created_at'（作成日時）の新しい順（降順）で並び替えます。

  // データ取得中に何らかのエラーが発生した場合の処理です。
  if (error) {
    return <p>エラーが発生しました: {error.message}</p>
  }

  // 取得に成功した場合、投稿一覧を描画します。
  return (
    <div>
      <h1>投稿一覧</h1>
      {/* 取得したposts配列をmap関数でループ処理し、各投稿を表示します。 */}
      {posts.map((post) => (
        // Reactでは、リスト表示の各要素に一意の`key`を指定する必要があります。
        <div key={post.id}>{post.content}</div>
      ))}
    </div>
  )
}
```

> **【深掘りコラム】なぜServer Componentsでデータを取得するのか？**
>
> Next.jsでは、コンポーネントはデフォルトで**Server Components**になります。これは、**サーバー側で実行される**コンポーネントです。
>
> サーバー側でデータ取得を行うことには、大きなメリットがあります。
> 1.  **高速な初期表示:** ユーザーがページにアクセスした時点で、サーバーはすでにデータベースとの通信を終え、データを含んだ完全なHTMLを生成します。ユーザーのブラウザは、この完成品を受け取るだけなので、画面が表示されるまでの待ち時間が大幅に短縮されます。
> 2.  **セキュリティ:** データベースとの通信がサーバー内で完結するため、APIキーなどの秘密情報がユーザーのブラウザに漏れる心配がありません。
> 3.  **パフォーマンス:** データ取得や複雑な処理を高性能なサーバーに任せることで、ユーザーのスマートフォンやPCの負荷を軽減できます。
>
> このように、Server Componentsは、ユーザー体験とセキュリティの両方を向上させるための強力な仕組みなのです。

### ステップ5: データの作成 (Create) - Server Actionsで安全に

次に、新しい投稿を作成する機能を実装します。Next.jsの**Server Actions**を使い、サーバー側で安全にデータを操作します。

**▶ Cursorへの指示 (プロンプト例)**
> `app/posts/page.tsx`に、新しい投稿を追加するためのフォームを追加してください。
> フォームには`content`という名前の`textarea`と送信ボタンを設置します。
>
> このフォームが送信されたら、Server Actionを使ってSupabaseの`posts`テーブルに新しいレコードを追加する処理を実装してください。`user_id`は仮で固定のUUIDを入れてください。
> 投稿後はページをリフレッシュして新しい投稿が表示されるようにしてください。

Cursorはフォームと、それに対応するServer Actionを生成します。

```typescript:app/posts/page.tsx
// ... (既存のimport文)
// データ更新後にページのキャッシュを無効化（再検証）するための機能をインポートします。
import { revalidatePath } from 'next/cache'

export default async function PostsPage() {
  // ... (既存のデータ取得コード)

  // フォームが送信されたときにサーバー側で実行される関数（Server Action）を定義します。
  const createPost = async (formData: FormData) => {
    // この関数がサーバーサイドでのみ実行されることを明示します。
    'use server'

    // フォームデータから'content'という名前の入力値を取得します。
    const content = formData.get('content') as string
    // 内容が空の場合は、何もせずに処理を終了します。
    if (!content) return

    // Supabaseクライアントを使って、'posts'テーブルに新しいレコードを挿入（insert）します。
    const { error } = await supabase
      .from('posts')
      .insert({ 
        content: content, // フォームから受け取った内容
        // 仮のユーザーID。認証実装後は、ログインしているユーザーのIDに置き換えます。
        user_id: '00000000-0000-0000-0000-000000000000' 
      })

    // データ挿入時にエラーが発生した場合の処理です。
    if (error) {
      console.error(error) // 開発者向けにサーバーのコンソールにエラーを出力します。
      return
    }

    // データ更新が成功したら、'/posts'ページのキャッシュを破棄し、
    // 次回のアクセス時に最新のデータで再描画するようにNext.jsに伝えます。
    revalidatePath('/posts')
  }

  return (
    <div>
      {/* formのaction属性に、上で定義したServer Actionを直接渡します。 */}
      <form action={createPost}>
        <textarea name="content" rows={3} placeholder="いまどうしてる？" />
        <button type="submit">投稿</button>
      </form>

      <hr />

      <h1>投稿一覧</h1>
      {/* ... (既存の投稿一覧表示コード) */}
    </div>
  )
}
```

> **【深掘りコラム】Server Actionsって何がすごいの？**
>
> Server Actionsは、**「APIエンドポイントを作らずに、サーバー側の処理を直接呼び出す」**ための画期的な仕組みです。
>
> 従来、フォームからデータを送信してデータベースを更新する場合、
> 1.  データを受け取るためのAPIエンドポイント（例: `/api/posts`）を作成する。
> 2.  フォーム側では、そのAPIに対してデータを送信するJavaScriptコードを書く。
>
> という2段階の作業が必要でした。
>
> Server Actionsを使えば、関数に`'use server'`と書くだけで、その関数が安全なサーバー側の処理になります。そして、その関数をフォームの`action`に直接指定できるのです。
>
> **メリット:**
> - **コードの簡潔さ:** APIが不要になるため、書くべきコードの量が減り、コンポーネント内で処理が完結します。
> - **開発体験の向上:** フロントエンドとバックエンドの処理が同じファイルに記述できるため、データの流れが追いやすく、開発がスムーズになります。
> - **プログレッシブエンハンスメント:** JavaScriptが無効な環境でも、通常のフォーム送信として機能します。

---

## 3. 演習課題

### 課題1 (Essentialsプラン)
- あなたのアプリケーションに、このユニットで学んだ方法で「データの一覧表示機能」と「データの新規作成機能」を実装してください。（例: 商品リスト、タスクリスト、ブログ記事など）

### 課題2 (Transformationプラン)
- 課題1に加えて、「データの更新機能」と「データの削除機能」をServer Actionsを使って実装してください。
- **ヒント:** 更新・削除するレコードを特定するために、フォームに`<input type="hidden" name="id" value={post.id} />`のように、投稿IDを隠しフィールドとして含める必要があります。

## まとめ
このユニットでは、Cursorに指示を出すだけでSupabaseのセットアップからCRUD実装までが完了することを体験しました。これがVibe Coderの基本的な開発スタイルです。単に手順をなぞるだけでなく、「なぜこの技術を使うのか」「その背景にはどんな思想があるのか」を理解することで、AIとの対話はより深く、的確なものになります。

次のユニットでは、アプリケーションに「認証」という重要な概念を導入し、誰が操作しているのかを管理する方法を学びます。